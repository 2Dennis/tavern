---

test_name: Test querying for presence of value

includes:
  - !include common.yaml

stages:
  - name: Query from complex object
    request:
      url: "{host}/fake_dictionary"
      method: GET
    response:
      status_code: 200
      body:
        top: !anything
        an_integer: 123
        a_string: abc
      jmespath:
        - query: "top.Thing"

---

test_name: Test not giving a query fails

_xfail: verify

includes:
  - !include common.yaml

stages:
  - name: Query from complex object
    request:
      url: "{host}/fake_dictionary"
      method: GET
    response:
      status_code: 200
      jmespath:
        - expected: "value"

---

test_name: Test querying object with an expected value

includes:
  - !include common.yaml

stages:
  - name: Query from complex object
    request:
      url: "{host}/fake_dictionary"
      method: GET
    response:
      status_code: 200
      body:
        top: !anything
        an_integer: 123
        a_string: abc
      jmespath:
        - query: "top.Thing"
          expected: "value"

---

test_name: Test querying object and saving

includes:
  - !include common.yaml

stages:
  - name: Query from complex object
    request:
      url: "{host}/fake_dictionary"
      method: GET
    response:
      status_code: 200
      jmespath:
        - query: "top.Thing"
          expected: "value"
          save_as: jmes_saved_value

  - &send_saved_value
    name: Post saved value
    request:
      url: "{host}/echo"
      method: POST
      json:
        value: "{jmes_saved_value}"
    response:
      status_code: 200
      body:
        value: "{jmes_saved_value}"

---

test_name: Test querying object and saving without checking the value

includes:
  - !include common.yaml

stages:
  - name: Query from complex object
    request:
      url: "{host}/fake_dictionary"
      method: GET
    response:
      status_code: 200
      jmespath:
        - query: "top.Thing"
          save_as: jmes_saved_value

  - *send_saved_value

---

test_name: Test querying object and saving with a typetoken

includes:
  - !include common.yaml

stages:
  - name: Query from complex object
    request:
      url: "{host}/fake_dictionary"
      method: GET
    response:
      status_code: 200
      jmespath:
        - query: "top.Thing"
          expected: !anystr
          save_as: jmes_saved_value

  - *send_saved_value

---

test_name: Test querying nested list

includes:
  - !include common.yaml

stages:
  - name: Query from complex object
    request:
      url: "{host}/fake_dictionary"
      method: GET
    response:
      status_code: 200
      # NOTE: no 'body'
      jmespath:
        - query: "top.key"
          expected: "val"
